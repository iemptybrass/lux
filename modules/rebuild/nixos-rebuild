#!/usr/bin/env bash
args=("$@")
args=("${args[@]:2}")

if [ -e "${args[0]}" ]; then
  echo "Directory exists"
  dir=("${args[0]}")
  args=("${args[@]:1}")
else
  echo "Directory does not exist"
  dir="$(pwd)"
fi

tmpdir="$(mktemp -d)"
cp -r "$dir"/* "$tmpdir"

args="${args[*]}"
echo "/run/current-system/sw/bin/nixos-rebuild $1 --flake $tmpdir $args"
/run/current-system/sw/bin/nixos-rebuild "$1" --flake "$tmpdir" "$args"

rm -rf "$tmpdir"

echo "finished"